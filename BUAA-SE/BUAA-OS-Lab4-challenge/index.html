<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>BUAA-OS-Lab4_challenge sigactionå®ç° | Roisy's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="https://unpkg.com/normalize.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="https://unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://unpkg.com/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="https://s2.loli.net/2025/03/01/MF8SBrfc2xnP9Qb.jpg"><link rel="Shortcut Icon" type="image/x-icon" href="https://s2.loli.net/2025/03/01/MF8SBrfc2xnP9Qb.jpg"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="https://unpkg.com/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="https://unpkg.com/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="https://unpkg.com/toastr/build/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">BUAA-OS-Lab4_challenge sigactionå®ç°</h1><a id="logo" href="/.">Roisy's Blog</a><p class="description">ä¸€ä¸ªSEå­¦ç”Ÿçš„è‡ªç•™åœ°</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/tags/"><i class="fa fa-tag"> æ ‡ç­¾</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">BUAA-OS-Lab4_challenge sigactionå®ç°</h1><div class="post-meta">2024-08-29<span> | </span><span class="category"><a href="/categories/BUAA-SE/">BUAA-SE</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.4k</span><span class="post-meta-item-text"> å­—</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 20</span><span class="post-meta-item-text"> åˆ†é’Ÿ</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#sigaction%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">sigactionç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">ä»»åŠ¡æè¿°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%81%E5%AE%8F%E7%AD%89%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">æ•°æ®ç»“æ„ã€å®ç­‰è®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">ä¿¡å·ç›¸å…³è®¾ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Env%E7%BB%93%E6%9E%84%E4%BD%93%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98"><span class="toc-number">3.2.</span> <span class="toc-text">Envç»“æ„ä½“æ·»åŠ æˆå‘˜</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E8%BF%94%E5%9B%9E%E5%80%BC%E8%AE%BE%E7%BD%AE"><span class="toc-number">3.3.</span> <span class="toc-text">é”™è¯¯è¿”å›å€¼è®¾ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B4%E6%96%87%E4%BB%B6%E4%B8%AD%E6%B7%BB%E5%8A%A0%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0%E5%A3%B0%E6%98%8E"><span class="toc-number">3.4.</span> <span class="toc-text">å¤´æ–‡ä»¶ä¸­æ·»åŠ ç›¸å…³å‡½æ•°å£°æ˜</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E8%AE%BE%E7%BD%AE%E7%9B%B8%E5%85%B3%E5%89%8D%E7%BD%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">4.</span> <span class="toc-text">åˆå§‹åŒ–ä¸å…¨å±€å˜é‡è®¾ç½®ç›¸å…³å‰ç½®æ“ä½œ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E7%9B%B8%E5%85%B3%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">5.</span> <span class="toc-text">æ–°å¢ç›¸å…³ç³»ç»Ÿè°ƒç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E4%B8%80%E6%B5%81%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">ç»Ÿä¸€æµç¨‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0%E6%89%80%E9%9C%80%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8%E7%9A%84%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.2.</span> <span class="toc-text">æ–°å¢åŠŸèƒ½å®ç°æ‰€éœ€ç³»ç»Ÿè°ƒç”¨çš„å…·ä½“å®ç°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">6.</span> <span class="toc-text">ä¿¡å·å¤„ç†æµç¨‹å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E7%9A%84%E8%A7%A6%E5%8F%91"><span class="toc-number">6.1.</span> <span class="toc-text">ä¿¡å·å¤„ç†çš„è§¦å‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E7%B1%BB%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%8F%91%E9%80%81%E8%A7%A6%E5%8F%91"><span class="toc-number">6.2.</span> <span class="toc-text">å„ç±»ä¿¡å·çš„å‘é€è§¦å‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E6%B3%A8%E5%86%8C%E4%B8%8E%E5%8F%91%E9%80%81"><span class="toc-number">6.3.</span> <span class="toc-text">ä¿¡å·çš„æ³¨å†Œä¸å‘é€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">6.4.</span> <span class="toc-text">ä¿¡å·æ£€æŸ¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E7%9A%84%E5%AE%9E%E9%99%85%E5%A4%84%E7%90%86"><span class="toc-number">6.5.</span> <span class="toc-text">ä¿¡å·çš„å®é™…å¤„ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86%E5%90%8E%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E4%BF%A1%E5%8F%B7"><span class="toc-number">6.6.</span> <span class="toc-text">ä¿¡å·å¤„ç†åä¸Šä¸‹æ–‡çš„ä¿¡å·</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E5%8F%B7%E9%9B%86%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.</span> <span class="toc-text">ä¿¡å·é›†å¤„ç†å‡½æ•°å®ç°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E4%BF%AE%E6%94%B9%EF%BC%88%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">å…¶ä»–ä¿®æ”¹ï¼ˆè¸©è¿‡çš„å‘ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8Trapframe%E4%BF%9D%E5%AD%98%E4%B8%8E%E4%BC%A0%E9%80%92%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.1.</span> <span class="toc-text">å¯„å­˜å™¨Trapframeä¿å­˜ä¸ä¼ é€’è®¾ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fork%E6%97%B6%E7%9B%B8%E5%85%B3%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%BB%A7%E6%89%BF"><span class="toc-number">8.2.</span> <span class="toc-text">forkæ—¶ç›¸å…³è®¾ç½®çš„ç»§æ‰¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B5%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0%E5%85%A5%E5%8F%A3%E7%9A%84%E5%90%8C%E6%AD%A5%E8%AE%BE%E7%BD%AE"><span class="toc-number">8.3.</span> <span class="toc-text">é¡µé”™è¯¯å¤„ç†å‡½æ•°å…¥å£çš„åŒæ­¥è®¾ç½®</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%B8%A9%E8%BF%87%E7%9A%84%E5%9D%91-%E5%85%B3%E9%94%AE%E8%AE%BE%E8%AE%A1"><span class="toc-number">9.</span> <span class="toc-text">å…¶ä»–è¸©è¿‡çš„å‘&#x2F;å…³é”®è®¾è®¡</span></a></li></ol></div></div><div class="post-content"><h2 id="sigactionç®€ä»‹"><a href="#sigactionç®€ä»‹" class="headerlink" title="sigactionç®€ä»‹"></a><strong>sigactionç®€ä»‹</strong></h2><p><font color="green">å½“ä¸€ä¸ªä¿¡å·è¢«å‘é€ç»™ä¸€ä¸ªè¿›ç¨‹æ—¶</font>, å†…æ ¸ä¼šä¸­æ–­è¿›ç¨‹çš„æ­£å¸¸æ§åˆ¶æµï¼Œè½¬è€Œ<strong>æ‰§è¡Œä¸è¯¥ä¿¡å·ç›¸å…³çš„ç”¨æˆ·æ€å¤„ç†å‡½æ•°</strong>è¿›è¡Œå¤„ç†</p>
<p>åœ¨<font color="green">æ‰§è¡Œè¯¥å¤„ç†å‡½æ•°å‰</font>ï¼Œä¼š<font color="blue">å°†è¯¥ä¿¡å·æ‰€è®¾ç½®çš„ä¿¡å·å±è”½é›†åŠ å…¥åˆ°è¿›ç¨‹çš„ä¿¡å·å±è”½é›†</font>ä¸­ï¼Œåœ¨<font color="green">æ‰§è¡Œå®Œè¯¥ç”¨æˆ·æ€å¤„ç†å‡½æ•°å</font>ï¼Œåˆä¼š<font color="blue">å°†æ¢å¤åŸæ¥çš„ä¿¡å·å±è”½é›†</font></p>
<h2 id="ä»»åŠ¡æè¿°"><a href="#ä»»åŠ¡æè¿°" class="headerlink" title="ä»»åŠ¡æè¿°"></a><strong>ä»»åŠ¡æè¿°</strong></h2><p><code>sigaction</code>ç»“æ„ä½“ç”¨äºè®¾ç½®<font color="red"><strong>æ‰€éœ€è¦å¤„ç†çš„ä¿¡å·é›†åŠå…¶å¯¹åº”çš„å¤„ç†å‡½æ•°</strong></font></p>
<p><code>sigset_t</code>ä½¿ç”¨<font color="red"><strong>32ä½</strong></font>è¡¨ç¤ºMOSæ‰€éœ€è¦å¤„ç†çš„<font color="red"><strong>[1,32]ä¿¡å·æ©ç </strong>ï¼Œå¯¹åº”ä½ä¸º<strong>1è¡¨ç¤ºé˜»å¡</strong>ï¼Œä¸º0è¡¨ç¤ºæœªè¢«é˜»å¡</font></p>
<p><code>sigset_t</code>ä¸<code>sigaction</code>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sigset_t</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span> sig;</span><br><span class="line">&#125; <span class="type">sigset_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>     (*sa_handler)(<span class="type">int</span>); <span class="comment">//ä¿¡å·çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="type">sigset_t</span>   sa_mask;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="æ•°æ®ç»“æ„ã€å®ç­‰è®¾è®¡"><a href="#æ•°æ®ç»“æ„ã€å®ç­‰è®¾è®¡" class="headerlink" title="æ•°æ®ç»“æ„ã€å®ç­‰è®¾è®¡"></a>æ•°æ®ç»“æ„ã€å®ç­‰è®¾è®¡</h2><h3 id="ä¿¡å·ç›¸å…³è®¾ç½®"><a href="#ä¿¡å·ç›¸å…³è®¾ç½®" class="headerlink" title="ä¿¡å·ç›¸å…³è®¾ç½®"></a>ä¿¡å·ç›¸å…³è®¾ç½®</h3><p>æ­¤å¤„æŒ‚èµ·ä¿¡å·é˜Ÿåˆ—<font color='blue'>æ²¿ç”¨æ­¤å‰MOSä¸­è®¾è®¡çš„<strong>TAILQç»“æ„</strong>å¹¶ä½¿ç”¨ç›¸å…³å‡½æ•°</font>ï¼Œå®ç°å‚è€ƒ <code>kern\env.c</code> ä¸­<code>env_sched_list</code> ç›¸å…³éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/signal.h</span></span><br><span class="line"><span class="comment">// ä¿¡å·æ©ç æ§åˆ¶å® __howçš„å–å€¼</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIG_BLOCK (0)	<span class="comment">// æ·»åŠ __setåˆ°å½“å‰æ©ç </span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIG_UNBLOCK (1) <span class="comment">// ä»å½“å‰æ©ç ä¸­ç§»é™¤__set</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIG_SETMASK (2) <span class="comment">// è®¾ç½®å½“å‰æ©ç ä¸º__set</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SIGNUMç¼–å·</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGINT (2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGILL (4)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGKILL (9)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSEGV (11)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGCHLD (17)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIGSYS (31)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡å·æ•°é‡</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIG_MAX (32) </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ©ç ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sigset_t</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> sig;</span><br><span class="line">&#125; <span class="type">sigset_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡å·æ“ä½œç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*sa_handler)</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>     (*sa_handler)(<span class="type">int</span>);</span><br><span class="line">    <span class="type">sigset_t</span>   sa_mask;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡å·æè¿°ç¬¦</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signal</span> &#123;</span></span><br><span class="line">	TAILQ_ENTRY(signal) sig_link;</span><br><span class="line">	<span class="type">int</span> signum;</span><br><span class="line">	<span class="type">int</span> time;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‚èµ·çš„ä¿¡å·é˜Ÿåˆ—</span></span><br><span class="line">TAILQ_HEAD(Sig_pend_list, signal);</span><br></pre></td></tr></table></figure>

<h3 id="Envç»“æ„ä½“æ·»åŠ æˆå‘˜"><a href="#Envç»“æ„ä½“æ·»åŠ æˆå‘˜" class="headerlink" title="Envç»“æ„ä½“æ·»åŠ æˆå‘˜"></a>Envç»“æ„ä½“æ·»åŠ æˆå‘˜</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// env.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Env</span> &#123;</span></span><br><span class="line">	<span class="comment">// lab4-challenge</span></span><br><span class="line">	u_int env_user_sighand_entry;	<span class="comment">// ç”¨æˆ·æ€ä¿¡å·å¤„ç†å‡½æ•°å…¥å£</span></span><br><span class="line">	u_int now_sig_time;		<span class="comment">// è®°å½•å½“å‰æ­£åœ¨å¤„ç†çš„ä¿¡å·çš„åˆ°è¾¾æ—¶é—´ï¼Œé‡å…¥å¤„ç†çš„æ—¶å€™ç”¨</span></span><br><span class="line">	u_int is_handling_SIGKILL;		<span class="comment">// åˆ¤å®šç°åœ¨æ­£åœ¨è¢«å¤„ç†çš„æ˜¯å¦æ˜¯SIGKILLä¿¡å·ï¼Œè‹¥æ˜¯åˆ™ä¸º1ï¼Œåä¹‹ä¸º0</span></span><br><span class="line">	u_int sig_exist[<span class="number">32</span>];	<span class="comment">// æ¯ç§ä¿¡å·åœ¨å½“å‰è¿›ç¨‹çš„å­˜åœ¨æ€§åˆ¤æ–­ï¼Œä¿è¯æ¯ç§ä¿¡å·çš„å”¯ä¸€æ€§</span></span><br><span class="line">	<span class="type">sigset_t</span> sig_blocked;	       <span class="comment">// ä¿¡å·æ©ç </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Sig_pend_list</span> <span class="title">sig_pend_list</span>;</span>	<span class="comment">// æŒ‚èµ·ä¿¡å·é˜Ÿåˆ—</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sighand</span>[32];</span>  <span class="comment">// ä¿¡å·æ³¨å†Œæ•°ç»„</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="é”™è¯¯è¿”å›å€¼è®¾ç½®"><a href="#é”™è¯¯è¿”å›å€¼è®¾ç½®" class="headerlink" title="é”™è¯¯è¿”å›å€¼è®¾ç½®"></a>é”™è¯¯è¿”å›å€¼è®¾ç½®</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// include/error.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> E_SIG 1    <span class="comment">// å®é™…è¿ç”¨ä¸€èˆ¬éƒ½æ˜¯ return -E_SIG</span></span></span><br></pre></td></tr></table></figure>

<h3 id="å¤´æ–‡ä»¶ä¸­æ·»åŠ ç›¸å…³å‡½æ•°å£°æ˜"><a href="#å¤´æ–‡ä»¶ä¸­æ·»åŠ ç›¸å…³å‡½æ•°å£°æ˜" class="headerlink" title="å¤´æ–‡ä»¶ä¸­æ·»åŠ ç›¸å…³å‡½æ•°å£°æ˜"></a>å¤´æ–‡ä»¶ä¸­æ·»åŠ ç›¸å…³å‡½æ•°å£°æ˜</h3><p>ç”±äºæ²¡æœ‰å¤ªå¤šæŠ€æœ¯å«é‡ï¼Œæ­¤å¤„çœç•¥ï¼Œåœ¨å®ç°å…·ä½“å‡½æ•°ååˆ°ç›¸åº”å¤´æ–‡ä»¶ä¸­æ·»åŠ å³å¯</p>
<h2 id="åˆå§‹åŒ–ä¸å…¨å±€å˜é‡è®¾ç½®ç›¸å…³å‰ç½®æ“ä½œ"><a href="#åˆå§‹åŒ–ä¸å…¨å±€å˜é‡è®¾ç½®ç›¸å…³å‰ç½®æ“ä½œ" class="headerlink" title="åˆå§‹åŒ–ä¸å…¨å±€å˜é‡è®¾ç½®ç›¸å…³å‰ç½®æ“ä½œ"></a>åˆå§‹åŒ–ä¸å…¨å±€å˜é‡è®¾ç½®ç›¸å…³å‰ç½®æ“ä½œ</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/env.c</span></span><br><span class="line"><span class="comment">// lab4-challenge</span></span><br><span class="line"><span class="type">int</span> sigsTime = <span class="number">1</span>;    <span class="comment">// ç”¨äºæ ‡è®°ä¿¡å·åˆ°è¾¾æ—¶é—´ï¼Œè¶Šå°åˆ™åˆ°è¾¾æ—¶é—´è¶Šæ—©</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signal</span> <span class="title">signals</span>[<span class="title">SIG_MAX</span>] __<span class="title">attribute__</span>((<span class="title">aligned</span>(<span class="title">PAGE_SIZE</span>)));</span>    <span class="comment">// è¿›ç¨‹ä¿¡å·æ•°ç»„</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">env_alloc</span><span class="params">(<span class="keyword">struct</span> Env **new, u_int parent_id)</span> &#123;</span><br><span class="line">	<span class="comment">// lab4-challenge</span></span><br><span class="line">	<span class="comment">// æœ€åˆéƒ½åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">	e-&gt;sig_blocked.sig = <span class="number">0</span>;</span><br><span class="line">	e-&gt;env_user_sighand_entry = <span class="number">0</span>;</span><br><span class="line">	e-&gt;sig_pend_cnt = <span class="number">0</span>;</span><br><span class="line">	e-&gt;now_sig_time = <span class="number">0</span>;</span><br><span class="line">	e-&gt;is_handling_SIGKILL = <span class="number">0</span>;</span><br><span class="line">	TAILQ_INIT(&amp;e-&gt;sig_pend_list);</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">32</span>; i++)&#123;</span><br><span class="line">		e-&gt;sig_exist[i] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">32</span>; i++)&#123;</span><br><span class="line">		e-&gt;sighand[i].sa_handler = <span class="literal">NULL</span>;</span><br><span class="line">		e-&gt;sighand[i].sa_mask.sig = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ–°å¢ç›¸å…³ç³»ç»Ÿè°ƒç”¨"><a href="#æ–°å¢ç›¸å…³ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="æ–°å¢ç›¸å…³ç³»ç»Ÿè°ƒç”¨"></a>æ–°å¢ç›¸å…³ç³»ç»Ÿè°ƒç”¨</h2><h3 id="ç»Ÿä¸€æµç¨‹"><a href="#ç»Ÿä¸€æµç¨‹" class="headerlink" title="ç»Ÿä¸€æµç¨‹"></a>ç»Ÿä¸€æµç¨‹</h3><p>æ·»åŠ ç³»ç»Ÿè°ƒç”¨ <code>syscall_func(u_int envid, ......)</code>ï¼š</p>
<ol>
<li><p>åœ¨ <code>user/include/lib.h</code> ä¸­æ·»åŠ  <code>void syscall_func(u_int envid, ......);</code></p>
</li>
<li><p>åœ¨ <code>user/lib/syscall_lib.c</code> ä¸­æ·»åŠ </p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">syscall_func</span><span class="params">(u_int envid, ......)</span> &#123; </span><br><span class="line">	......</span><br><span class="line">	msyscall(SYS_func, envid, ......);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨ <code>include/syscall.h</code> ä¸­çš„ <code>enum</code> çš„ <code>MAX_SYSNO</code> å‰æ·»åŠ  <code>SYS_func,</code></p>
</li>
<li><p>åœ¨ <code>kern/syscall_all.c</code> çš„ <code>void *syscall_table[MAX_SYSNO]</code> ä¸­åŠ ä¸Š <code>[SYS_func] = sys_func,</code> ï¼ˆæ³¨æ„ä¸å‰ä¸€æ­¥çš„å¯¹åº”ï¼‰</p>
</li>
<li><p>åœ¨ <code>kern/syscall_all.c</code> çš„ <code>void *syscall_table[MAX_SYSNO]</code> ä¹‹é—´å®Œæˆå‡½æ•°<br><code>void sys_func(u_int envid, ......);</code> çš„å…·ä½“å®ç°</p>
</li>
</ol>
<h3 id="æ–°å¢åŠŸèƒ½å®ç°æ‰€éœ€ç³»ç»Ÿè°ƒç”¨çš„å…·ä½“å®ç°"><a href="#æ–°å¢åŠŸèƒ½å®ç°æ‰€éœ€ç³»ç»Ÿè°ƒç”¨çš„å…·ä½“å®ç°" class="headerlink" title="æ–°å¢åŠŸèƒ½å®ç°æ‰€éœ€ç³»ç»Ÿè°ƒç”¨çš„å…·ä½“å®ç°"></a>æ–°å¢åŠŸèƒ½å®ç°æ‰€éœ€ç³»ç»Ÿè°ƒç”¨çš„å…·ä½“å®ç°</h3><ul>
<li><p><code>sys_</code> å…·ä½“å®ç°</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/syscall_all.c</span></span><br><span class="line"><span class="comment">// ä¿¡å·æ³¨å†Œ</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_sigaction</span><span class="params">(<span class="type">int</span> signum, <span class="type">const</span> <span class="keyword">struct</span> sigaction *newact, </span></span><br><span class="line"><span class="params">														\<span class="keyword">struct</span> sigaction *oldact)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> *<span class="title">sig</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">// åªéœ€è€ƒè™‘signumå°äºæˆ–ç­‰äº32çš„æƒ…å†µ,è¶…å‡ºè¯¥èŒƒå›´è¿”å›-1</span></span><br><span class="line">	<span class="keyword">if</span> (signum &lt; <span class="number">1</span> || signum &gt; SIG_MAX) &#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;</span><br><span class="line">	e = curenv;</span><br><span class="line">	sig = &amp;e-&gt;sighand[signum - <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">if</span> (oldact) &#123;</span><br><span class="line">		*oldact = *sig;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (newact) &#123;</span><br><span class="line">		*sig = *newact;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®è¿›ç¨‹çš„ä¿¡å·å¤„ç†å‡½æ•°å…¥å£åœ°å€</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_set_sighand_entry</span><span class="params">(u_int envid, u_int func)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">env</span>;</span></span><br><span class="line">	try(envid2env(envid, &amp;env, <span class="number">1</span>));</span><br><span class="line">	env-&gt;env_user_sighand_entry = func;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘è¿›ç¨‹å‘é€ä¿¡å·</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> sigsTime;</span><br><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">signal</span> <span class="title">signals</span>[<span class="title">SIG_MAX</span>] __<span class="title">attribute__</span>((<span class="title">aligned</span>(<span class="title">PAGE_SIZE</span>)));</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_sendsig</span><span class="params">(u_int envid, <span class="type">int</span> sig)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">	<span class="comment">// å½“envidå¯¹åº”è¿›ç¨‹ä¸å­˜åœ¨ï¼Œæˆ–è€…sigä¸ç¬¦åˆå®šä¹‰èŒƒå›´æ—¶ï¼Œè¿”å›å¼‚å¸¸ç -1</span></span><br><span class="line">	<span class="keyword">if</span> ( sig &lt; <span class="number">1</span> || sig &gt; SIG_MAX || envid2env(envid, &amp;e, <span class="number">0</span>) != <span class="number">0</span> ) &#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="comment">// å½“è¿›ç¨‹ä¸­å·²ç»æœ‰åŒç§ä¿¡å·ï¼Œåˆ™ä¸å†æ¥æ”¶</span></span><br><span class="line">	<span class="keyword">if</span> ( e-&gt;sig_exist[sig<span class="number">-1</span>] == <span class="number">1</span> )&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å°†ä¿¡å·æ·»åŠ è¿›å¯¹åº”è¿›ç¨‹çš„ä¿¡å·å¤„ç†é˜Ÿåˆ—</span></span><br><span class="line">	signals[sig<span class="number">-1</span>].signum = sig;</span><br><span class="line">	signals[sig<span class="number">-1</span>].time = sigsTime;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">signal</span> *<span class="title">s</span> =</span> (<span class="keyword">struct</span> signal *)(&amp;signals[sig<span class="number">-1</span>]);</span><br><span class="line">	e-&gt;sig_exist[sig<span class="number">-1</span>] = <span class="number">1</span>;</span><br><span class="line">	TAILQ_INSERT_HEAD(&amp;e-&gt;sig_pend_list, (s), sig_link);</span><br><span class="line">	sigsTime++;</span><br><span class="line">	e-&gt;sig_pend_cnt++;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®__howçš„å€¼æ›´æ”¹å½“å‰è¿›ç¨‹çš„ä¿¡å·å±è”½å­—</span></span><br><span class="line"><span class="comment">// __setæ˜¯è¦åº”ç”¨çš„æ–°æ©ç ï¼Œ__osetï¼ˆå¦‚æœéNULLï¼‰åˆ™ä¿å­˜æ—§çš„ä¿¡å·å±è”½å­—</span></span><br><span class="line"><span class="comment">// __howå¯ä»¥æ˜¯SIG_BLOCKï¼ˆæ·»åŠ __setåˆ°å½“å‰æ©ç ï¼‰ã€SIG_UNBLOCKï¼ˆä»å½“å‰æ©ç ä¸­ç§»é™¤__setï¼‰</span></span><br><span class="line"><span class="comment">//         æˆ–SIG_SETMASKï¼ˆè®¾ç½®å½“å‰æ©ç ä¸º__setï¼‰</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_sigprocmask</span><span class="params">(<span class="type">int</span> __how, <span class="type">const</span> <span class="type">sigset_t</span> * __set, <span class="type">sigset_t</span> * __oset)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">e</span>;</span></span><br><span class="line">	<span class="type">sigset_t</span> *sigset;</span><br><span class="line">	e = curenv;</span><br><span class="line">	sigset = &amp;e-&gt;sig_blocked;</span><br><span class="line">	<span class="keyword">if</span> (__oset!=<span class="literal">NULL</span>) &#123;</span><br><span class="line">		*__oset = *sigset;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (__set!=<span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="keyword">switch</span> (__how) &#123;</span><br><span class="line">			<span class="keyword">case</span> SIG_BLOCK:</span><br><span class="line">				sigset-&gt;sig |= __set-&gt;sig;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SIG_UNBLOCK:</span><br><span class="line">				sigset-&gt;sig &amp;= ~__set-&gt;sig;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> SIG_SETMASK:</span><br><span class="line">				sigset-&gt;sig = __set-&gt;sig;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				<span class="keyword">return</span> -E_SIG;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ä¿¡å·__signoæ˜¯å¦æ˜¯__setä¿¡å·é›†çš„æˆå‘˜ã€‚å¦‚æœæ˜¯ï¼Œè¿”å›1ï¼›å¦‚æœä¸æ˜¯ï¼Œè¿”å›0ã€‚</span></span><br><span class="line"><span class="type">int</span> _sigismember(<span class="type">const</span> <span class="type">sigset_t</span> *__set, <span class="type">int</span> __signo)&#123;</span><br><span class="line">	<span class="keyword">if</span> (__set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	__signo -= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span> &amp; (__set-&gt;sig &gt;&gt; (__signo));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰è¢«é˜»å¡ä¸”æœªå¤„ç†çš„ä¿¡å·é›†ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨__setä¸­</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_sigpending</span><span class="params">(<span class="type">sigset_t</span> *__set)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">signal</span> *<span class="title">s</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">int</span> t;</span><br><span class="line">	<span class="type">uint32_t</span> newSig = __set-&gt;sig;</span><br><span class="line">	TAILQ_FOREACH (s, &amp;curenv-&gt;sig_pend_list, sig_link) &#123;</span><br><span class="line">		<span class="comment">// æ£€æŸ¥æ©ç </span></span><br><span class="line">		<span class="keyword">if</span> ( _sigismember(&amp;curenv-&gt;sig_blocked, s-&gt;signum) ) &#123;</span><br><span class="line">			t = s-&gt;signum;</span><br><span class="line">			newSig |= (<span class="number">1</span> &lt;&lt; (t<span class="number">-1</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	__set-&gt;sig = newSig;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–è¿›ç¨‹çŠ¶æ€</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_check_env_status</span><span class="params">(u_int envid)</span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> * <span class="title">e</span>;</span></span><br><span class="line">	try(envid2env(envid, &amp;e, <span class="number">0</span>));</span><br><span class="line">	<span class="keyword">return</span> e-&gt;env_status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>éƒ¨åˆ†é™¤ <code>msyscall</code> è¿˜æœ‰å…¶ä»–æ“ä½œçš„ <code>syscall_</code></p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/syscall_lib.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">syscall_sigaction</span><span class="params">(<span class="type">int</span> signum, <span class="type">const</span> <span class="keyword">struct</span> sigaction *newact, </span></span><br><span class="line"><span class="params">																	\<span class="keyword">struct</span> sigaction *oldact)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (oldact) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(oldact, <span class="number">0</span>, <span class="keyword">sizeof</span>(oldact));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> msyscall(SYS_sigaction, signum, newact, oldact);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">syscall_sigprocmask</span><span class="params">(<span class="type">int</span> __how, <span class="type">const</span> <span class="type">sigset_t</span> * __set, <span class="type">sigset_t</span> * __oset)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (__oset) &#123;</span><br><span class="line">		<span class="built_in">memset</span>(__oset, <span class="number">0</span>, <span class="keyword">sizeof</span>(__oset));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> msyscall(SYS_sigprocmask, __how, __set, __oset);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="ä¿¡å·å¤„ç†æµç¨‹å®ç°"><a href="#ä¿¡å·å¤„ç†æµç¨‹å®ç°" class="headerlink" title="ä¿¡å·å¤„ç†æµç¨‹å®ç°"></a>ä¿¡å·å¤„ç†æµç¨‹å®ç°</h2><h3 id="ä¿¡å·å¤„ç†çš„è§¦å‘"><a href="#ä¿¡å·å¤„ç†çš„è§¦å‘" class="headerlink" title="ä¿¡å·å¤„ç†çš„è§¦å‘"></a>ä¿¡å·å¤„ç†çš„è§¦å‘</h3><p>åœ¨ <code>ret_from_exception</code> ä¸­åŠ å…¥è·³è½¬åˆ° <code>do_signal</code> çš„ä»£ç ï¼Œ<font color='red'>ä½¿å¾—æ¯æ¬¡ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€éƒ½è°ƒç”¨ä¸€æ¬¡ä¿¡å·æ£€æŸ¥å‡½æ•°</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// kern/genex.S</span><br><span class="line">FEXPORT(ret_from_exception)</span><br><span class="line">	// åŠ å…¥è·³è½¬åˆ°do_signalçš„ä»£ç ï¼ˆæ¯æ¬¡ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€éƒ½è°ƒç”¨ä¸€æ¬¡ï¼‰</span><br><span class="line">		 move    a0, sp</span><br><span class="line">     addiu   sp, sp, -8</span><br><span class="line">     jal     do_signal</span><br><span class="line">     addiu   sp, sp, 8</span><br></pre></td></tr></table></figure>

<h3 id="å„ç±»ä¿¡å·çš„å‘é€è§¦å‘"><a href="#å„ç±»ä¿¡å·çš„å‘é€è§¦å‘" class="headerlink" title="å„ç±»ä¿¡å·çš„å‘é€è§¦å‘"></a>å„ç±»ä¿¡å·çš„å‘é€è§¦å‘</h3><ul>
<li><p><code>SIGINT</code> ä¸ <code>SIGKILL</code> ä¸€èˆ¬åœ¨ç¨‹åºä¸­æ‰‹åŠ¨è§¦å‘ï¼Œä¸ä¼šç›´æ¥åœ¨MOSä»£ç ä¸­å‘é€</p>
</li>
<li><p><code>SIGILL</code></p>
<p>  <em>å‘é€å¥‘æœº</em> ï¼š<font color='green'>åœ¨è¿›è¡Œå¼‚å¸¸å¤„ç†å‰ï¼Œå‘ç°å½“å‰å¼‚å¸¸ç”±<strong>éæ³•æŒ‡ä»¤</strong>å¼•å‘</font>ï¼Œå‘è‡ªèº«å‘é€ <code>SIGILL</code></p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/traps.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_reserved</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(((tf-&gt;cp0_cause &gt;&gt; <span class="number">2</span>) &amp; <span class="number">0x1f</span>) == <span class="number">10</span>)&#123;</span><br><span class="line">        sys_sendsig(<span class="number">0</span>, SIGILL);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>SIGSEGV</code></p>
<p>  <em>å‘é€å¥‘æœº</em> ï¼š<font color='green'>å½“å‰åœ°å€è¿‡ä½ä¸å…è®¸è®¿é—®</font>ï¼Œåˆ™å‘è‡ªèº«å‘é€ <code>SIGSEGV</code></p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/tlbex.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">passive_alloc</span><span class="params">(u_int va, Pde *pgdir, u_int asid)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (va &lt; UTEMP) &#123;</span><br><span class="line">		<span class="comment">// panic(&quot;address too low&quot;);</span></span><br><span class="line">		sys_sendsig(curenv-&gt;env_id, SIGSEGV);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>SIGCHLD</code></p>
<p>  <em>å‘é€å¥‘æœº</em> ï¼š<font color='green'>å­è¿›ç¨‹é€€å‡ºæ—¶ï¼Œè‹¥çˆ¶è¿›ç¨‹ä»åœ¨è¿è¡Œ</font>ï¼Œåˆ™å­è¿›ç¨‹å‘çˆ¶è¿›ç¨‹å‘é€ <code>SIGCHLD</code></p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/env.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">env_destroy</span><span class="params">(<span class="keyword">struct</span> Env *e)</span> &#123;</span><br><span class="line">	<span class="comment">// lab4-challenge</span></span><br><span class="line">	<span class="keyword">if</span>( e-&gt;env_parent_id != <span class="number">0</span>)&#123;</span><br><span class="line">		sys_sendsig( e-&gt;env_parent_id, SIGCHLD);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>SIGSYS</code></p>
<p>  <em>å‘é€å¥‘æœº</em> ï¼š<font color='green'>å½“å‰ç³»ç»Ÿè°ƒç”¨å·ä¸å­˜åœ¨æ—¶</font>ï¼Œéœ€è¦<font color='red'>å…ˆ<strong>å¿½è§†ï¼ˆè·³è¿‡ï¼‰æ­¤æ¡è¯­å¥</strong></font>ï¼Œå†å‘è‡ªèº«å‘é€ <code>SIGSYS</code></p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/syscall_all.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_syscall</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span> &#123;</span><br><span class="line">	<span class="type">int</span> sysno = tf-&gt;regs[<span class="number">4</span>];</span><br><span class="line">	<span class="keyword">if</span> (sysno &lt; <span class="number">0</span> || sysno &gt;= MAX_SYSNO) &#123;</span><br><span class="line">		tf-&gt;regs[<span class="number">2</span>] = -E_NO_SYS;</span><br><span class="line">		tf-&gt;cp0_epc += <span class="number">4</span>;</span><br><span class="line">		sys_sendsig(curenv-&gt;env_id, SIGSYS);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="ä¿¡å·çš„æ³¨å†Œä¸å‘é€"><a href="#ä¿¡å·çš„æ³¨å†Œä¸å‘é€" class="headerlink" title="ä¿¡å·çš„æ³¨å†Œä¸å‘é€"></a>ä¿¡å·çš„æ³¨å†Œä¸å‘é€</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿¡å·æ³¨å†Œå‡½æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaction</span><span class="params">(<span class="type">int</span> signum, <span class="type">const</span> <span class="keyword">struct</span> sigaction *newact, <span class="keyword">struct</span> sigaction *oldact)</span> &#123;</span><br><span class="line">	<span class="comment">// ç¡®ä¿è®¾ç½®å¥½ä¿¡å·å¤„ç†å‡½æ•°å…¥å£åœ°å€</span></span><br><span class="line">	<span class="keyword">if</span> (env-&gt;env_user_sighand_entry != (u_int)sighand_entry) &#123;</span><br><span class="line">		try(syscall_set_sighand_entry(<span class="number">0</span>, (u_int)sighand_entry));</span><br><span class="line">		try(syscall_set_tlb_mod_entry(<span class="number">0</span>, (u_int)entry_wrapper));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> r = syscall_sigaction(signum, newact, oldact);</span><br><span class="line">	<span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿¡å·å‘é€å‡½æ•°</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">kill</span><span class="params">(u_int envid, <span class="type">int</span> sig)</span> &#123;</span><br><span class="line">	<span class="comment">// å¦‚æœsigä¸ºSIGCHLD,SIGILL,SIGSYS,SIGSEGVä¿¡å·ï¼Œè¿”å›å¼‚å¸¸ç -1</span></span><br><span class="line">	<span class="keyword">if</span> (sig == SIGILL || sig == SIGSYS || sig == SIGCHLD || sig == SIGSEGV) &#123;</span><br><span class="line">		<span class="comment">// debugf(&quot;Only MOS can send SIGCHLD &amp; SIGILL &amp; SIGSYS &amp; SIGSEGV signal.\n&quot;);</span></span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ç¡®ä¿è®¾ç½®å¥½ä¿¡å·å¤„ç†å‡½æ•°å…¥å£åœ°å€</span></span><br><span class="line">	<span class="keyword">if</span> (env-&gt;env_user_sighand_entry != (u_int)sighand_entry) &#123;</span><br><span class="line">		try(syscall_set_sighand_entry(<span class="number">0</span>, (u_int)sighand_entry));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> r = syscall_sendsig(envid, sig);</span><br><span class="line">	<span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¿¡å·æ£€æŸ¥"><a href="#ä¿¡å·æ£€æŸ¥" class="headerlink" title="ä¿¡å·æ£€æŸ¥"></a>ä¿¡å·æ£€æŸ¥</h3><ul>
<li><code>do_signal</code> å®ç°å¯¹å½“å‰æŒ‚èµ·ä¿¡å·é˜Ÿåˆ—çš„æ£€æŸ¥ï¼Œé€‰æ‹©åˆé€‚çš„ä¿¡å·å<font color='red'>è°ƒç”¨ <code>sig_setuptf</code> è·³è½¬åˆ°ä¿¡å·å¤„ç†å‡½æ•°å…¥å£å¹¶ä¸ºå…¶ä¼ é€’å‚æ•°</font></li>
<li>ä¿å­˜å¯„å­˜å™¨ä¸Šä¸‹æ–‡å‡½æ•° <code>sig_setuptf</code> å‚ç…§ <code>kern\tlbex.c</code> ä¸­ <code>do_tlb_mod</code> å®ç°ï¼Œå…·ä½“å‚æ•°è®¾è®¡è§åç»­ä¿¡å·å¤„ç†å‡½æ•°å…¥å£</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/env.c</span></span><br><span class="line"><span class="comment">// lab4-challenge</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_signal</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span> &#123;</span><br><span class="line">	<span class="comment">// åœ¨ä¸ºè¿›ç¨‹è®¾ç½®sigpriä¹‹å‰ä¹Ÿå¯èƒ½ä¼šå‘ç”Ÿä¸€äº›å¼‚å¸¸äº§ç”Ÿå¼‚å¸¸é‡å…¥çš„ç°è±¡</span></span><br><span class="line">	<span class="comment">// è€Œå¼‚å¸¸é‡å…¥çš„æ—¶å€™ä¸å¯èƒ½äº§ç”Ÿä»»ä½•æ–°çš„ä¿¡å·,æ²¡å¿…è¦å¤„ç†ä¿¡å·,ç›´æ¥return</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="type">int</span>)tf-&gt;cp0_epc)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å¦‚æœæ²¡æœ‰å¾…å¤„ç†ä¿¡å·ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">if</span> (TAILQ_EMPTY(&amp;curenv-&gt;sig_pend_list))&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">signal</span> *<span class="title">s</span> =</span> <span class="literal">NULL</span>, *s_min = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">int</span> signo = <span class="number">10000</span>;    <span class="comment">// åˆå§‹åŒ–ä¸º10000ï¼Œåç»­ç”¨äºåˆ¤æ–­å½“å‰ä¿¡å·ä¼˜å…ˆçº§æ˜¯å¦é«˜äºä¹‹å‰é€‰ä¸­çš„ä¿¡å·</span></span><br><span class="line">	<span class="type">int</span> time = <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// ä»è¿›ç¨‹çš„é˜Ÿåˆ—ä¸­å–å‡ºæœªè¢«é˜»å¡çš„signal</span></span><br><span class="line">	<span class="comment">// SIGKILLä¼˜å…ˆçº§æœ€é«˜</span></span><br><span class="line">	<span class="keyword">if</span> (curenv-&gt;sig_exist[SIGKILL<span class="number">-1</span>] == <span class="number">1</span>)&#123;</span><br><span class="line">,		TAILQ_FOREACH (s_min, &amp;curenv-&gt;sig_pend_list, sig_link) &#123;</span><br><span class="line">			<span class="keyword">if</span> (s_min-&gt;signum == SIGKILL) &#123;</span><br><span class="line">				signo = s_min-&gt;signum;</span><br><span class="line">				time = s_min-&gt;time;</span><br><span class="line">				curenv-&gt;is_handling_SIGKILL = <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span>(curenv-&gt;is_handling_SIGKILL == <span class="number">0</span>)&#123;</span><br><span class="line">		TAILQ_FOREACH (s, &amp;curenv-&gt;sig_pend_list, sig_link) &#123;</span><br><span class="line">			<span class="comment">// å¦‚æœå½“å‰æœ‰ä¿¡å·æ­£åœ¨å¤„ç†ä¸”æ­¤ä¿¡å·æ¯”å½“å‰ä¿¡å·åˆ°è¾¾æ—¶é—´æ—©ï¼Œåˆ™break</span></span><br><span class="line">			<span class="keyword">if</span> ( s-&gt;time &lt;= curenv-&gt;now_sig_time )&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// é€‰å–ä¼˜å…ˆçº§æœ€é«˜çš„</span></span><br><span class="line">			<span class="keyword">if</span> ( s-&gt;signum &lt; signo </span><br><span class="line">						&amp;&amp; ( (curenv-&gt;sig_blocked.sig &amp; (<span class="number">1</span>&lt;&lt;(s-&gt;signum<span class="number">-1</span>))) == <span class="number">0</span> ))&#123;</span><br><span class="line">				signo = s-&gt;signum;</span><br><span class="line">				time = s-&gt;time;</span><br><span class="line">				s_min = s;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// è‹¥å­˜åœ¨æœªè¢«é˜»å¡çš„signal, åˆ™ä¿®æ”¹è¿›ç¨‹ä¸Šä¸‹æ–‡, è½¬åˆ°ç”¨æˆ·æ€çš„ä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (s_min) &#123;</span><br><span class="line">		curenv-&gt;now_sig_time = time;</span><br><span class="line">		curenv-&gt;sig_exist[signo<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">		TAILQ_REMOVE(&amp;curenv-&gt;sig_pend_list, s_min, sig_link);</span><br><span class="line">		<span class="comment">// ä¿å­˜å¯„å­˜å™¨ä¸Šä¸‹æ–‡ï¼Œç»™ä¿¡å·å¤„ç†å‡½æ•°ä¼ é€’å‚æ•°</span></span><br><span class="line">		sig_setuptf(tf, signo);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿å­˜å¯„å­˜å™¨ä¸Šä¸‹æ–‡ï¼ˆä»¿å†™do_tlb_modï¼‰</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_setuptf</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf, <span class="type">int</span> signum)</span> &#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> <span class="title">tmp_tf</span> =</span> *tf;</span><br><span class="line">	<span class="keyword">if</span> (tf-&gt;regs[<span class="number">29</span>] &lt; USTACKTOP || tf-&gt;regs[<span class="number">29</span>] &gt;= UXSTACKTOP) &#123;</span><br><span class="line">		tf-&gt;regs[<span class="number">29</span>] = UXSTACKTOP;</span><br><span class="line">	&#125;</span><br><span class="line">	tf-&gt;regs[<span class="number">29</span>] -= <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Trapframe);</span><br><span class="line">	*(<span class="keyword">struct</span> Trapframe *)tf-&gt;regs[<span class="number">29</span>] = tmp_tf;</span><br><span class="line">	<span class="comment">// å°†ä¿¡å·å¤„ç†éœ€è¦ä¼ é€’çš„ç›¸å…³å‚æ•°ä¿å­˜è‡³å¼‚å¸¸ç°åœºæ ˆä¸­</span></span><br><span class="line">	tf-&gt;regs[<span class="number">4</span>] = tf-&gt;regs[<span class="number">29</span>];</span><br><span class="line">	tf-&gt;regs[<span class="number">5</span>] = signum;</span><br><span class="line">	tf-&gt;regs[<span class="number">6</span>] = (<span class="type">unsigned</span> <span class="type">int</span>)(curenv-&gt;sighand[signum<span class="number">-1</span>].sa_handler);</span><br><span class="line">	<span class="type">uint32_t</span> newMask = <span class="number">0</span>;</span><br><span class="line">	newMask = curenv-&gt;sighand[signum<span class="number">-1</span>].sa_mask.sig | curenv-&gt;sig_blocked.sig </span><br><span class="line">																									\ | (<span class="number">1</span> &lt;&lt; (signum - <span class="number">1</span>)) ;</span><br><span class="line">	tf-&gt;regs[<span class="number">7</span>] = (<span class="type">uint32_t</span>)newMask;</span><br><span class="line">	tf-&gt;regs[<span class="number">29</span>] -= <span class="keyword">sizeof</span>(tf-&gt;regs[<span class="number">4</span>]);</span><br><span class="line">	tf-&gt;regs[<span class="number">29</span>] -= <span class="keyword">sizeof</span>(tf-&gt;regs[<span class="number">5</span>]);</span><br><span class="line">	tf-&gt;regs[<span class="number">29</span>] -= <span class="keyword">sizeof</span>(tf-&gt;regs[<span class="number">6</span>]);</span><br><span class="line">	tf-&gt;regs[<span class="number">29</span>] -= <span class="keyword">sizeof</span>(tf-&gt;regs[<span class="number">7</span>]);</span><br><span class="line">	tf-&gt;cp0_epc = curenv-&gt;env_user_sighand_entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ä¿¡å·çš„å®é™…å¤„ç†"><a href="#ä¿¡å·çš„å®é™…å¤„ç†" class="headerlink" title="ä¿¡å·çš„å®é™…å¤„ç†"></a>ä¿¡å·çš„å®é™…å¤„ç†</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰§è¡Œä¿¡å·</span></span><br><span class="line"><span class="type">void</span> __attribute__((<span class="keyword">noreturn</span>)) sighand_entry(<span class="keyword">struct</span> Trapframe *tf, <span class="type">int</span> signum, </span><br><span class="line">																	\	<span class="type">void</span> (*sa_handler)(<span class="type">int</span>), <span class="type">uint32_t</span> newMask) &#123;</span><br><span class="line">	<span class="type">int</span> r;</span><br><span class="line">	<span class="comment">// è‹¥è®¾ç½®äº†å¤„ç†å‡½æ•°</span></span><br><span class="line">	<span class="keyword">if</span> (sa_handler &amp;&amp; signum != SIGKILL ) &#123;</span><br><span class="line">		<span class="comment">// å¤„ç†å‰ä¿®æ”¹è¿›ç¨‹æ©ç </span></span><br><span class="line">		<span class="type">sigset_t</span> oldSigset=&#123;<span class="number">0</span>&#125;, newSigset=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">		newSigset.sig = newMask;</span><br><span class="line">		r= syscall_sigprocmask(<span class="number">2</span>, (<span class="type">sigset_t</span> *)&amp;newSigset, (<span class="type">sigset_t</span> *)&amp;oldSigset);</span><br><span class="line">		sa_handler(signum);</span><br><span class="line">		<span class="comment">// æ¢å¤è¿›ç¨‹åŸæ©ç </span></span><br><span class="line">		syscall_sigprocmask(<span class="number">2</span>, (<span class="type">sigset_t</span> *)&amp;oldSigset, <span class="literal">NULL</span>);</span><br><span class="line">		<span class="comment">// æ¢å¤ä¸Šä¸‹æ–‡</span></span><br><span class="line">		r = syscall_set_sig_trapframe(<span class="number">0</span>, tf);</span><br><span class="line">		user_panic(<span class="string">&quot;sig_entry syscall_set_sig_trapframe returned %d&quot;</span>, r);</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">switch</span> (signum) &#123;</span><br><span class="line">        <span class="keyword">case</span> SIGINT: <span class="keyword">case</span> SIGILL: <span class="keyword">case</span> SIGKILL: <span class="keyword">case</span> SIGSEGV: </span><br><span class="line">				<span class="comment">// é€€å‡ºç”¨exit</span></span><br><span class="line">            <span class="built_in">exit</span>(); </span><br><span class="line">            user_panic(<span class="string">&quot;sig_entry syscall_env_destroy returned&quot;</span>);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            r = syscall_set_sig_trapframe(<span class="number">0</span>, tf);</span><br><span class="line">            user_panic(<span class="string">&quot;sig_entry syscall_set_sig_trapframe returned %d&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ä¿¡å·å¤„ç†åä¸Šä¸‹æ–‡çš„ä¿¡å·"><a href="#ä¿¡å·å¤„ç†åä¸Šä¸‹æ–‡çš„ä¿¡å·" class="headerlink" title="ä¿¡å·å¤„ç†åä¸Šä¸‹æ–‡çš„ä¿¡å·"></a>ä¿¡å·å¤„ç†åä¸Šä¸‹æ–‡çš„ä¿¡å·</h3><p>å‚è€ƒåŒæ–‡ä»¶ä¸­çš„ <code>sys_set_trapframe</code> å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/syscall_all.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_set_sig_trapframe</span><span class="params">(u_int envid, <span class="keyword">struct</span> Trapframe *tf)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (is_illegal_va_range((u_long)tf, <span class="keyword">sizeof</span> *tf)) &#123;</span><br><span class="line">		<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> *<span class="title">env</span>;</span></span><br><span class="line">	try(envid2env(envid, &amp;env, <span class="number">1</span>));</span><br><span class="line">	<span class="comment">// å½“å‰ä¿¡å·å¤„ç†å®Œæ¯•ï¼Œæ•…é‡ç½® env-&gt;now_sig_time ä¸º 0</span></span><br><span class="line">	env-&gt;now_sig_time = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (env == curenv) &#123;</span><br><span class="line">		*((<span class="keyword">struct</span> Trapframe *)KSTACKTOP - <span class="number">1</span>) = *tf;</span><br><span class="line">		<span class="comment">// return `tf-&gt;regs[2]` instead of 0, because return value overrides regs[2] on</span></span><br><span class="line">		<span class="comment">// current trapframe.</span></span><br><span class="line">		<span class="keyword">return</span> tf-&gt;regs[<span class="number">2</span>];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		env-&gt;env_tf = *tf;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ä¿¡å·é›†å¤„ç†å‡½æ•°å®ç°"><a href="#ä¿¡å·é›†å¤„ç†å‡½æ•°å®ç°" class="headerlink" title="ä¿¡å·é›†å¤„ç†å‡½æ•°å®ç°"></a>ä¿¡å·é›†<strong>å¤„ç†å‡½æ•°å®ç°</strong></h2><p>æ³¨æ„å¦‚æœ<font color='green'>ä¼ å…¥å‚æ•°ä¸åˆæ³•</font>ï¼Œè¿”å›å€¼ä¸º <code>-E_SIG</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/syscall_lib.c</span></span><br><span class="line"><span class="comment">// è®¡ç®—ä¸¤ä¸ªä¿¡å·é›†__leftå’Œ__rightçš„å¹¶é›†ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨__setä¸­</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigorset</span><span class="params">(<span class="type">sigset_t</span> *__set, <span class="type">const</span> <span class="type">sigset_t</span> *__left, <span class="type">const</span> <span class="type">sigset_t</span> *__right)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __left == <span class="literal">NULL</span> ||  __right == <span class="literal">NULL</span> )&#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;</span><br><span class="line">	__set-&gt;sig = __left-&gt;sig | __right-&gt;sig;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®__howçš„å€¼æ›´æ”¹å½“å‰è¿›ç¨‹çš„ä¿¡å·å±è”½å­—ã€‚__setæ˜¯è¦åº”ç”¨çš„æ–°æ©ç </span></span><br><span class="line"><span class="comment">// __osetï¼ˆå¦‚æœéNULLï¼‰åˆ™ä¿å­˜æ—§çš„ä¿¡å·å±è”½å­—</span></span><br><span class="line"><span class="comment">// __howå¯ä»¥æ˜¯SIG_BLOCKï¼ˆæ·»åŠ __setåˆ°å½“å‰æ©ç ï¼‰ã€SIG_UNBLOCKï¼ˆä»å½“å‰æ©ç ä¸­ç§»é™¤__setï¼‰</span></span><br><span class="line"><span class="comment">//   æˆ–SIG_SETMASKï¼ˆè®¾ç½®å½“å‰æ©ç ä¸º__setï¼‰</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigprocmask</span><span class="params">(<span class="type">int</span> __how, <span class="type">const</span> <span class="type">sigset_t</span> * __set, <span class="type">sigset_t</span> * __oset)</span>&#123;</span><br><span class="line">	syscall_sigprocmask(__how, __set, __oset);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…ç©ºå‚æ•°ä¸­çš„__setæ©ç ï¼Œåˆå§‹åŒ–ä¿¡å·é›†ä»¥æ’é™¤æ‰€æœ‰ä¿¡å·ã€‚è¿™æ„å‘³ç€__setå°†ä¸åŒ…å«ä»»ä½•ä¿¡å·ã€‚(æ¸…0)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigemptyset</span><span class="params">(<span class="type">sigset_t</span> *__set)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	__set-&gt;sig = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å‚æ•°ä¸­çš„__setæ©ç å¡«æ»¡ï¼Œä½¿å…¶åŒ…å«æ‰€æœ‰å·²å®šä¹‰çš„ä¿¡å·ã€‚è¿™æ„å‘³ç€__setå°†åŒ…æ‹¬æ‰€æœ‰ä¿¡å·ã€‚(å…¨ä¸º1)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigfillset</span><span class="params">(<span class="type">sigset_t</span> *__set)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;</span><br><span class="line">	sigemptyset(__set);</span><br><span class="line">	__set-&gt;sig = ~(__set-&gt;sig);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘__setä¿¡å·é›†ä¸­æ·»åŠ ä¸€ä¸ªä¿¡å·__signoã€‚å¦‚æœæ“ä½œæˆåŠŸï¼Œ__setå°†åŒ…å«è¯¥ä¿¡å·ã€‚(ç½®ä½ä¸º1)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaddset</span><span class="params">(<span class="type">sigset_t</span> *__set, <span class="type">int</span> __signo)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( __signo &lt; <span class="number">1</span> || __signo &gt; SIG_MAX ) &#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;;</span><br><span class="line">	__set-&gt;sig |= (<span class="number">1</span>&lt;&lt;(__signo<span class="number">-1</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»__setä¿¡å·é›†ä¸­åˆ é™¤ä¸€ä¸ªä¿¡å·__signoã€‚å¦‚æœæ“ä½œæˆåŠŸï¼Œ__setå°†ä¸å†åŒ…å«è¯¥ä¿¡å·ã€‚(ç½®ä½ä¸º0)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigdelset</span><span class="params">(<span class="type">sigset_t</span> *__set, <span class="type">int</span> __signo)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> ( __signo &lt; <span class="number">1</span> || __signo &gt; SIG_MAX ) &#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;;</span><br><span class="line">	__set-&gt;sig &amp;= ~(<span class="number">1</span>&lt;&lt;(__signo<span class="number">-1</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ä¿¡å·__signoæ˜¯å¦æ˜¯__setä¿¡å·é›†çš„æˆå‘˜ã€‚å¦‚æœæ˜¯ï¼Œè¿”å›1ï¼›å¦‚æœä¸æ˜¯ï¼Œè¿”å›0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigismember</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *__set, <span class="type">int</span> __signo)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span> &amp; (__set-&gt;sig &gt;&gt; (__signo<span class="number">-1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥ä¿¡å·é›†__setæ˜¯å¦ä¸ºç©ºã€‚å¦‚æœä¸ºç©ºï¼Œè¿”å›1ï¼›å¦‚æœä¸ä¸ºç©ºï¼Œè¿”å›0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigisemptyset</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *__set)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> __set-&gt;sig == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—ä¸¤ä¸ªä¿¡å·é›†__leftå’Œ__rightçš„äº¤é›†ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨__setä¸­ã€‚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigandset</span><span class="params">(<span class="type">sigset_t</span> *__set, <span class="type">const</span> <span class="type">sigset_t</span> *__left, <span class="type">const</span> <span class="type">sigset_t</span> *__right)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __left == <span class="literal">NULL</span> ||  __right == <span class="literal">NULL</span> )&#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;</span><br><span class="line">	__set-&gt;sig = __left-&gt;sig &amp; __right-&gt;sig;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å½“å‰è¢«é˜»å¡ä¸”æœªå¤„ç†çš„ä¿¡å·é›†ï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨__setä¸­</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigpending</span><span class="params">(<span class="type">sigset_t</span> *__set)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( __set == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> -E_SIG;</span><br><span class="line">	&#125;</span><br><span class="line">	syscall_sigpending( __set);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…¶ä»–ä¿®æ”¹ï¼ˆè¸©è¿‡çš„å‘ï¼‰"><a href="#å…¶ä»–ä¿®æ”¹ï¼ˆè¸©è¿‡çš„å‘ï¼‰" class="headerlink" title="å…¶ä»–ä¿®æ”¹ï¼ˆè¸©è¿‡çš„å‘ï¼‰"></a>å…¶ä»–ä¿®æ”¹ï¼ˆè¸©è¿‡çš„å‘ï¼‰</h2><h3 id="å¯„å­˜å™¨Trapframeä¿å­˜ä¸ä¼ é€’è®¾ç½®"><a href="#å¯„å­˜å™¨Trapframeä¿å­˜ä¸ä¼ é€’è®¾ç½®" class="headerlink" title="å¯„å­˜å™¨Trapframeä¿å­˜ä¸ä¼ é€’è®¾ç½®"></a>å¯„å­˜å™¨Trapframeä¿å­˜ä¸ä¼ é€’è®¾ç½®</h3><p>å½“ <code>env_pop_tf</code> å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¼šå°† <code>curenv-&gt;env_tf</code>ï¼ˆå³å½“å‰è¿›ç¨‹çš„ä¸Šä¸‹æ–‡ï¼‰åŠ è½½åˆ°å¤„ç†å™¨å¯„å­˜å™¨ä¸­ï¼Œå¹¶ä¸”å°† <code>curenv-&gt;env_tf</code> çš„åœ°å€èµ‹å€¼ç»™å †æ ˆæŒ‡é’ˆ <code>sp</code>ã€‚è¿›å…¥ <code>do_signal</code> å‡½æ•°æ—¶ï¼Œå †æ ˆæŒ‡é’ˆ <code>sp</code> æŒ‡å‘ <code>curenv-&gt;env_tf</code> çš„ä½ç½®ã€‚</p>
<p>å‡è®¾ <code>do_signal</code> å‡½æ•°ä¼šåœ¨å…¶æ‰§è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨å †æ ˆä¿å­˜ä¸´æ—¶æ•°æ®å’Œå‡½æ•°è°ƒç”¨ä¿¡æ¯ï¼Œåˆ™<font color='red'>è¿™äº›æ•°æ®ä¼š<strong>è¦†ç›–</strong> <code>curenv-&gt;env_tf</code> çš„å†…å®¹ï¼Œå¯¼è‡´<strong>è¿›ç¨‹æ§åˆ¶å—ä¸­çš„æ•°æ®è¢«æ„å¤–ä¿®æ”¹</strong></font>ã€‚</p>
<p>æ‰€ä»¥éœ€è¦é€šè¿‡<font color='blue'>å°† <code>curenv-&gt;env_tf</code> å¤åˆ¶åˆ°å½“å‰<strong>æ ˆä¸Šä¸€ä¸ªä¸´æ—¶å˜é‡</strong> <code>tmp_tf</code>ï¼Œç„¶åä¼ å…¥ <code>env_pop_tf</code> å‡½æ•°</font>ï¼Œä»è€Œ<font color='red'><strong>é¿å…ç›´æ¥ä½¿ç”¨è¿›ç¨‹æ§åˆ¶å—ä¸­çš„åœ°å€</strong></font>ã€‚</p>
<p>å°†Â <code>kern/env.c</code>Â æ–‡ä»¶ä¸­Â <code>env_run</code>Â å‡½æ•°çš„æœ«å°¾ä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- env_pop_tf(&amp;curenv-&gt;env_tf, curenv-&gt;env_asid);</span></span><br><span class="line"><span class="addition">+ struct Trapframe tmp_tf = curenv-&gt;env_tf;</span></span><br><span class="line"><span class="addition">+ env_pop_tf(&amp;tmp_tf, curenv-&gt;env_asid);</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Qï¼šä¸ºä»€ä¹ˆä¸èƒ½å°† <code>curenv-&gt;env_tf</code> å¤åˆ¶åˆ° (struct Trapframe *)KSTACKTOP - 1ï¼Ÿ</p>
<p>å› ä¸º<code>KSTACKTOP</code> æ˜¯å†…æ ¸æ ˆçš„é¡¶éƒ¨ï¼Œç›´æ¥åœ¨æ­¤ä½ç½®å­˜å‚¨ <code>Trapframe</code> ç»“æ„ä½“ç¨æœ‰ä¸æ…å¯èƒ½å¯¼è‡´å †æ ˆæº¢å‡ºï¼Œä»è€Œè¦†ç›–å…¶ä»–å…³é”®çš„å†…æ ¸æ•°æ®ï¼Œ<font color='red'>å¹²æ‰°å†…æ ¸æ ˆçš„æ­£å¸¸ä½¿ç”¨</font></p>
</blockquote>
<h3 id="forkæ—¶ç›¸å…³è®¾ç½®çš„ç»§æ‰¿"><a href="#forkæ—¶ç›¸å…³è®¾ç½®çš„ç»§æ‰¿" class="headerlink" title="forkæ—¶ç›¸å…³è®¾ç½®çš„ç»§æ‰¿"></a>forkæ—¶ç›¸å…³è®¾ç½®çš„ç»§æ‰¿</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kern/syscall_all.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sys_exofork</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="comment">// lab4-challenge</span></span><br><span class="line">	<span class="comment">// å…¨éƒ¨å’Œsigactionæœ‰å…³çš„éƒ½è¦å¤åˆ¶</span></span><br><span class="line">	e-&gt;sig_blocked = curenv-&gt;sig_blocked;</span><br><span class="line">	e-&gt;env_user_sighand_entry = curenv-&gt;env_user_sighand_entry;</span><br><span class="line">	e-&gt;sig_pend_cnt = curenv-&gt;sig_pend_cnt;</span><br><span class="line">	e-&gt;now_sig_time = curenv-&gt;now_sig_time;</span><br><span class="line">	e-&gt;is_handling_SIGKILL = <span class="number">0</span>;</span><br><span class="line">	e-&gt;sig_pend_list = curenv-&gt;sig_pend_list;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">32</span>; i++)&#123;</span><br><span class="line">		e-&gt;sig_exist[i] = curenv-&gt;sig_exist[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">32</span>; i++)&#123;</span><br><span class="line">		e-&gt;sighand[i].sa_handler = curenv-&gt;sighand[i].sa_handler;</span><br><span class="line">		e-&gt;sighand[i].sa_mask.sig = curenv-&gt;sighand[i].sa_mask.sig;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶ï¼Œ<font color='red'>ä¸ºäº†é˜²æ­¢çˆ¶è¿›ç¨‹æ²¡æœ‰æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</font>ï¼Œåœ¨forkæ—¶å¯ä»¥â€œå†åŠ ä¸€å±‚ä¿é™©â€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/fork.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">	<span class="comment">// lab4-challenge</span></span><br><span class="line">	<span class="keyword">if</span> (env-&gt;env_user_sighand_entry != (u_int)sighand_entry) &#123;</span><br><span class="line">		try(syscall_set_sighand_entry(<span class="number">0</span>, (u_int)sighand_entry));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é¡µé”™è¯¯å¤„ç†å‡½æ•°å…¥å£çš„åŒæ­¥è®¾ç½®"><a href="#é¡µé”™è¯¯å¤„ç†å‡½æ•°å…¥å£çš„åŒæ­¥è®¾ç½®" class="headerlink" title="é¡µé”™è¯¯å¤„ç†å‡½æ•°å…¥å£çš„åŒæ­¥è®¾ç½®"></a>é¡µé”™è¯¯å¤„ç†å‡½æ•°å…¥å£çš„åŒæ­¥è®¾ç½®</h3><p>åœ¨å®é™…ç¼–ç ä¸­ï¼Œå‘ç°å¯èƒ½ä¼šå‡ºç°é¡µé”™è¯¯æƒ…å†µï¼ŒæŠ¥é”™æœªæ³¨å†Œé¡µé”™è¯¯å¤„ç†å‡½æ•°ã€‚å› æ­¤ï¼Œåœ¨æ³¨å†Œä¿¡å·æ—¶ä¹Ÿå®ç°é¡µé”™è¯¯å¤„ç†å‡½æ•°å…¥å£çš„åŒæ­¥è®¾ç½®</p>
<p>ç”±äº <code>cow_entry</code> æ˜¯é™æ€å‡½æ•°ï¼Œå› æ­¤éœ€è¦ç”¨ä¸€ä¸ªå‡½æ•°å°†å…¶åŒ…è£¹ä»¥ä¾¿åœ¨å…¶ä»–æ–‡ä»¶ä¸­è°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/lib/fork.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">entry_wrapper</span><span class="params">(<span class="keyword">struct</span> Trapframe *tf)</span> &#123;</span><br><span class="line">    cow_entry(tf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…¶ä»–è¸©è¿‡çš„å‘-å…³é”®è®¾è®¡"><a href="#å…¶ä»–è¸©è¿‡çš„å‘-å…³é”®è®¾è®¡" class="headerlink" title="å…¶ä»–è¸©è¿‡çš„å‘&#x2F;å…³é”®è®¾è®¡"></a>å…¶ä»–è¸©è¿‡çš„å‘&#x2F;å…³é”®è®¾è®¡</h2><ul>
<li>éœ€è¦<font color='red'>åŒºåˆ†â€œæ‰“æ–­â€ä¸â€œæ—©å·²åˆ°â€</font>å¹¶å¦¥å–„è®¾è®¡<ul>
<li><em>é—®é¢˜</em>ï¼šåœ¨ä¸€ä¸ªä¿¡å·å¤„ç†å®Œæˆä¹‹å‰ï¼Œä¹Ÿå¯èƒ½ä¼šè¿›è¡Œä¸€äº›ç³»ç»Ÿè°ƒç”¨ï¼Œ<font color='red'>è¿™äº›ç³»ç»Ÿè°ƒç”¨åœ¨è¿”å›ä¹‹å‰ä¹Ÿä¼šæ‰«æä¿¡å·é˜Ÿåˆ—ï¼Œæ€ä¹ˆé˜²æ­¢ç³»ç»Ÿè½¬è€Œå»æ‰§è¡Œæ›´æ—©åˆ°è¾¾çš„ä¿¡å·ï¼ˆæ—©å·²åˆ°ï¼‰ï¼Ÿ</font>ä½†åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦å…è®¸å½“å‰å¤„ç†å®Œæˆä¹‹å‰ï¼Œ<font color='red'>æ™šäºå½“å‰ä¿¡å·åˆ°è¾¾çš„ä¿¡å·ï¼ˆæ‰“æ–­ï¼‰èƒ½å¤Ÿè¢«å…ˆå¤„ç†</font>ã€‚</li>
<li><em>è§£å†³æ€è·¯</em>ï¼š<ol>
<li>å…ˆåœ¨ <code>env.c</code> é‡Œè®¾ç½®ä¸€ä¸ªå…¨å±€å˜é‡ <code>sigsTime</code></li>
<li>æ¯æ¬¡å‘é€ä¿¡å·çš„æ—¶å€™è®© <code>s-&gt;sig_time=sigsTime</code> ï¼Œç„¶å <code>sigsTime++</code></li>
<li>ç»™ <code>Env</code> ç»“æ„ä½“å¢åŠ æˆå‘˜å˜é‡ <code>handlingSig_time</code> ï¼Œè¿›ç¨‹æ¯å¼€å§‹å¤„ç†ä¸€ä¸ªä¿¡å·å°±è®© <code>curenv-&gt;handlingSig_time=s-&gt;sig_time</code></li>
<li>åœ¨ <code>dosignal</code> ä¸­æ ¹æ®æ¯”è¾ƒ <code>s-&gt;sig_time</code> å’Œ <code>curenv-&gt;handlingSig_time=s-&gt;sig_time</code> çš„å¤§å°æ¥åˆ¤æ–­ä¿¡å·å‘å‡ºçš„å…ˆå</li>
</ol>
</li>
<li><em>ä¸ä¸¥è°¨çš„åœ°æ–¹</em>ï¼šå‘é€ä¿¡å·çš„æ—¶é—´ä¸ä¸¥æ ¼ç­‰äºä¿¡å·å¼€å§‹è¢«å¤„ç†çš„æ—¶é—´ï¼Œåç»­å¯ä»¥ä¼˜åŒ–</li>
</ul>
</li>
<li><font color='red'>å¤„ç†å‰ä¿®æ”¹è¿›ç¨‹æ©ç ï¼Œå¤„ç†åæ¢å¤è¿›ç¨‹åŸæ©ç çš„å®ç°éœ€è¦å°å¿ƒè°¨æ…</font>ï¼Œè¦æƒ³æ¸…æ¥šåˆ°åº•è¦æ¢å¤æˆä»€ä¹ˆæ ·</li>
</ul>
</div><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://roisyl.github.io/BUAA-SE/BUAA-OS-Lab4-challenge/" data-id="cm7styog5000d0sgpgw2gh52d" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLklEQVR42u3aQY7bQAwEQP//0w6QU4DE3m5Sm8SjmpNhyFqVDr3DIR+PeD1/rleff13J9a/u//t9Ll4YGBgfy3i+Xe2jv3qU99/k93xJxcDAuAEjD9nkUfbX5H8XAwMDIw/TJLLfb/veBz0GBgZGG7hJ2dmy/8H/DQwMjI9itHHZFqV5BH97LY6BgfGBjH1j4Ps+/9X+BgYGxn/JeI7WZtu3L4n/8FsMDIyjGflBWFL0tpE9+yaKXQwMjOMYmwGIthhuh8OK4zYMDIyjGbMWZttubB+uPlbDwMA4lJGPPiS3y1ue7f2/uAYDA+NoRl5A7oveBLYKbgwMjEMZ+dH/bMwiT8UWjIGBcR/GJnBz6qxJmRfSGBgYZzPaH7chOHvc/EU82neJgYHxgYx92TnL+LZ8HbYNMDAwDmK00ZY3I/dvN99uYmBgnM2YdQNnJWjygupZNgwMjNsw2rHUFtOGaT3AioGBcTRjFpezsYkvehQbJAYGxtGMfOS0HU69dv8WFckYGBiHMtq+Qd6YbMfLZttEDAyM+zDyUjM/jNsc4eUbRAwMjDsw2kGHNuU2x2pJFwADA+NsxrNcs6DcN0eLngYGBsZxjFlCXzV+2l7ZFtsYGBgnMTYDXm352h76FxtWDAyMGzD2wZc3O2dbvXrMAgMD48aMdpwiedzNUBoGBgbG7M9c1eDMXxwGBsYdGHkzYBO++dZzeCKIgYFxKGM2nbEJ3M33l/U3MDAwPoPxA3JL+ggqWbqsAAAAAElFTkSuQmCC">åˆ†äº«</a><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lab/" rel="tag">Lab</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OS/" rel="tag">OS</a></li></ul></div><div class="post-nav"><a class="next" href="/BUAA-SE/BUAA-OS-Lab-General/">BUAA-OS-Lab ç»éªŒæ€»ç»“</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="https://unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="https://unpkg.com/blueimp-md5/js/md5.js"></script><script type="text/javascript" src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: 'Ov23li2QyqRzt8XAlrKY',
  clientSecret: 'd43f2b587c8782b1e92215b56ea07a73762fdfbb',
  repo: 'blog.gitalk',
  owner: 'RoisyL',
  admin: ['RoisyL'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="å…³äº"><img class="nofancybox" src="/img/rabbit.jpg"/></a><p class="author-description">Mind and Hand</p><a class="info-icon" href="https://github.com/RoisyL" title="Welcome to my GitHub" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/BUAA-SE/">BUAA-SE</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/Lab/" style="font-size: 15px;">Lab</a> <a href="/tags/OS/" style="font-size: 15px;">OS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab4-challenge/">BUAA-OS-Lab4_challenge sigactionå®ç°</a></li><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab-General/">BUAA-OS-Lab ç»éªŒæ€»ç»“</a></li><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab5/">BUAA-OS-Lab5 æ–‡ä»¶ç³»ç»Ÿ</a></li><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab4/">BUAA-OS-Lab4 ç³»ç»Ÿè°ƒç”¨ä¸fork</a></li><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab3/">BUAA-OS-Lab3 è¿›ç¨‹ä¸å¼‚å¸¸</a></li><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab2/">BUAA-OS-Lab2 å†…å­˜ç®¡ç†</a></li><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab1/">BUAA OS-Lab1 å†…æ ¸ã€å¯åŠ¨å’Œ PRINTF</a></li><li class="post-list-item"><a class="post-list-link" href="/BUAA-SE/BUAA-OS-Lab0/">BUAA OS-Lab0 LinuxåŸºç¡€æ“ä½œ</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2025 <a href="/." rel="nofollow">Roisy's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/tufu9441"> tufu9441.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="https://unpkg.com/@fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="å¤åˆ¶æˆåŠŸï¼"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
  });
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML" async></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>